# ä¸€ã€æ¦‚è¿°

[mongodb-org >>](https://www.mongodb.com/docs/manual/)

[mongoosejs-docs >>](https://mongoosejs.com/docs/guide.html)

MongoDBæ˜¯ä¸€ä¸ªç”±C++ è¯­è¨€ç¼–å†™çš„ **åŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„æ•°æ®åº“**ã€‚

MongoDBä¸­çš„ä¸€æ¡è®°å½•æ˜¯ä¸€ä¸ªæ–‡æ¡£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±å­—æ®µå’Œå€¼å¯¹ç»„æˆçš„æ•°æ®ç»“æ„ã€‚MongoDBæ–‡æ¡£ç±»ä¼¼äºJSONå¯¹è±¡ã€‚å­—æ®µçš„å€¼å¯ä»¥åŒ…æ‹¬å…¶ä»–æ–‡æ¡£ã€æ•°ç»„å’Œæ–‡æ¡£æ•°ç»„ã€‚

![](./images/form.png)

**@ä¼˜åŠ¿**:

- åœ¨è®¸å¤šç¼–ç¨‹è¯­è¨€ä¸­ï¼Œæ–‡æ¡£å¯¹åº”äºæœ¬åœ°æ•°æ®ç±»å‹ã€‚
- åµŒå…¥çš„æ–‡æ¡£å’Œæ•°ç»„å‡å°‘äº†å¯¹æ˜‚è´µè¿æ¥çš„éœ€è¦ã€‚
- åŠ¨æ€æ¨¡å¼æ”¯æŒè¿è´¯å¤šæ€æ€§ã€‚

**@vs mySql**

- Mysql æ•°æ®åº“æ˜¯ç±»ä¼¼äºExcel **è¡¨æ ¼å¼** çš„æ•°æ®ï¼Œè¿™ç§è¡¨æ ¼å¼çš„æ•°æ®åº“ä¹Ÿç§°ä¹‹ä¸º **å…³ç³»å‹æ•°æ®åº“**ï¼Œè¡¨å«åš**å…³ç³»è¡¨**ã€‚

- MongoDB æ•°æ®åº“å­˜å‚¨çš„æ˜¯ç±»ä¼¼ **JSON** æ ¼å¼çš„æ•°æ®ï¼Œç§°ä¹‹ä¸º **bson**ï¼Œè¿™ç§æ•°æ®åº“ç”±äºæ¯”è¾ƒè‡ªç”±ï¼Œæ•°æ®é—´å¹¶ä¸ä¸€å®šæœ‰å…³ç³»ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**éå…³ç³»å‹æ•°æ®åº“**ã€‚ç„¶ååˆç”±äºä¸æ˜¯è¡¨ç»“æ„ï¼Œæˆ‘ä»¬ä¸å†ä½¿ç”¨sqlè¯­å¥å»æ“ä½œä»–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°MongoDBä¸º **nosql** æ•°æ®åº“çš„ä¸€ç§ã€‚

**@ç‰¹ç‚¹**

é«˜æ€§èƒ½ã€æ˜“éƒ¨ç½²ã€æ˜“ä½¿ç”¨ï¼Œå­˜å‚¨æ•°æ®éå¸¸æ–¹ä¾¿ã€‚

**@æ¦‚å¿µ**

| SQLæœ¯è¯­/æ¦‚å¿µ  | MongoDBæœ¯è¯­/æ¦‚å¿µ | è§£é‡Š/è¯´æ˜                              |
| :------------ | :--------------- | :------------------------------------- |
| `database`    | `database`       | æ•°æ®åº“                                 |
| `table`       | `collection`     | æ•°æ®åº“è¡¨/é›†åˆ                          |
| `row`         | `document`       | æ•°æ®è®°å½•è¡Œ/æ–‡æ¡£                        |
| `column`      | `field`          | æ•°æ®å­—æ®µ/åŸŸ                            |
| `index`       | `index`          | ç´¢å¼•                                   |
| `table joins` |                  | è¡¨è¿æ¥ï¼ŒMongoDBä¸æ”¯æŒ                  |
| `Primary key` | `Primary key`    | ä¸»é”®ï¼ŒMongoDBè‡ªåŠ¨å°†`_id`å­—æ®µè®¾ç½®ä¸ºä¸»é”® |

> [å‚ç…§ SQL åˆ° MongoDB çš„æ˜ å°„å›¾æ ‡ >>](https://docs.mongoing.com/mongodb-crud-operations/sql-to-mongodb-mapping-chart)

# äºŒã€å®‰è£…ã€å¯åŠ¨

## 1. ä¸‹è½½

[ç‚¹å‡»å‰å¾€å®˜ç½‘ä¸‹è½½ä¸­å¿ƒ >>](https://www.mongodb.com/try/download/community)

![](./images/download.png)

æ ¹æ®ç³»ç»Ÿï¼Œé€‰æ‹©ç›¸åº”çš„å®‰è£…åŒ…ã€‚

## 2. å®‰è£…

### macOS

**â‘  å°†å‹ç¼©åŒ…è§£å‹è‡³ä»»æ„ä½ç½®ï¼Œæˆ‘æ”¾åœ¨ *`/usr/local/`* ç›®å½•ä¸‹ï¼Œå¹¶é‡æ–°å‘½åä¸º *`mongodb`***

**â‘¡ æ·»åŠ ç¯å¢ƒå˜é‡**

```shell
$ open ~/.bash_profile
```

```shell
export MONGODB=/usr/local/mongodb/bin 
export PATH=$PATH:$MONGODB
```

**â‘¢ æŸ¥çœ‹ç‰ˆæœ¬ï¼Œå¦‚æœæ­£å¸¸æ˜¾ç¤ºç‰ˆæœ¬å·åˆ™å®‰è£…æˆåŠŸ**

```shell
$ mongo --version
MongoDB shell version v5.0.3
```

**â‘£ åˆ›å»ºç›®å½•**

```shell
$ cd /usr/local/mongodb/
$ mkdir -p data/logs data/db
$ cd /data/logs && touch mongodb.log
```

### windows

**â‘  ä¸‹è½½ msi æ–‡ä»¶ä¹‹åï¼ŒåŒå‡»å®‰è£…**

**â‘¡ ä¿®æ”¹å®‰è£…ç›®å½•**

é»˜è®¤ä¼šå®‰è£…åˆ°Cç›˜ï¼Œä½ å¯ä»¥ä¿®æ”¹å®‰è£…ç›®å½•ï¼š

![](./images/cg_install_loc_1.png)

![](./images/cg_install_loc_2.png)

**â‘¢. å–æ¶ˆå‹¾é€‰ Install MongoDB Compass**

åœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¦‚ä¸‹ç•Œé¢ï¼Œå…¶ä¸­ **install mongoDB compass** ä¸è¦å‹¾é€‰éœ€è¦å»æ‰ï¼Œå¦åˆ™å¯èƒ½è¦å¾ˆé•¿æ—¶é—´éƒ½ä¸€ç›´åœ¨æ‰§è¡Œå®‰è£…ã€‚

MongoDB Compass æ˜¯ä¸€ä¸ªå›¾å½¢ç•Œé¢ç®¡ç†å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åé¢è‡ªå·±åˆ°å®˜ç½‘ä¸‹è½½å®‰è£…ï¼Œ[å‰å¾€ä¸‹è½½ >>](https://www.mongodb.com/download-center/compass)ã€‚

![](./images/no_compass.png)



**â‘£ å®‰è£…å®Œæˆ**

- å®‰è£…ç›®å½•ä¸‹åˆ›å»ºdbç›®å½•ï¼š*`E:\MongoDB\data\db`*
- ç„¶åå°† bin ç›®å½•é…ç½®è¿›å…¥**ç¯å¢ƒå˜é‡**ï¼Œé…ç½®æ­¥éª¤ï¼šå³å»ºæ­¤ç”µè„‘ â†’ å±æ€§ â†’ é«˜çº§ç³»ç»Ÿè®¾ç½® â†’ ç¯å¢ƒå˜é‡

## 3. é…ç½®æ–‡ä»¶

[å‚è€ƒæ–‡æ¡£ >>](https://www.mongodb.com/docs/manual/reference/configuration-options/)

æ–‡ä»¶ä½ç½®ï¼š

- macOSï¼š*` /usr/local/etc/mongod.conf`*

- windowsï¼š*`<install directory>\bin\mongod.cfg`*

> **ï¼Tipsï¼š**ä¸Šé¢ä¸€èˆ¬æ˜¯é»˜è®¤çš„é…ç½®æ–‡ä»¶ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¯è‡ªè¡Œåœ¨å®‰è£…ä½ç½® `bin` ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶å³å¯ã€‚

é…ç½®æ–‡ä»¶ï¼Œä»¥ `macOs` ä¸ºä¾‹ï¼š

```ini
# mongod.conf

# for documentation of all options, 
# see: http://docs.mongodb.org/manual/reference/configuration-options/

# ğŸ‘‰ æ•°æ®åº“è®¾ç½® 
storage:
  # æ•°æ®åº“å­˜æ”¾åœ°å€
  dbPath: /usr/local/mongodb/data/db
  # å¯ç”¨æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤å¯ç”¨
  journal:
    enabled: true

# ğŸ‘‰ æ—¥å¿—ç®¡ç†
systemLog:
  destination: file
  # é”™è¯¯æ—¥å¿—é‡‡ç”¨è¿½åŠ æ¨¡å¼
  # é…ç½®è¿™ä¸ªé€‰é¡¹åmongodbçš„æ—¥å¿—ä¼šè¿½åŠ åˆ°ç°æœ‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä»æ–°åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶
  logAppend: true
  # æ—¥å¿—è¾“å‡ºæ–‡ä»¶è·¯å¾„
  path:  /usr/local/mongodb/data/logs/mongodb.log
  # è¿™ä¸ªé€‰é¡¹å¯ä»¥è¿‡æ»¤æ‰ä¸€äº›æ— ç”¨çš„æ—¥å¿—ä¿¡æ¯ï¼Œè‹¥éœ€è¦è°ƒè¯•ä½¿ç”¨è¯·è®¾ç½®ä¸ºfalse
  quiet: true
 
# ğŸ‘‰ è¿›ç¨‹å®ˆæŠ¤ï¼ˆï¼Tipsï¼šwindows ä¸æ”¯æŒï¼‰ 
processManagement:
   fork: true
   
# ğŸ‘‰ ç½‘ç»œè®¾ç½®
net:
  # ç«¯å£å·
  port: 27017
  # ç»‘å®šIPåœ°å€
  bindIp: 0.0.0.0

# ğŸ‘‰ å®‰å…¨è®¤è¯
security:
  authorization: enabled
```

> **ï¼Tips**ï¼š
>
> - `windows` ä¸æ”¯æŒè¿›ç¨‹å®ˆæŠ¤
> - ä½ åº”è¯¥å°† `storage.dbpath` å’Œ `systemLog.path` è®¾ç½®ä¸ºä½ æœ¬åœ°åœ°å€ã€‚

## 4. å¯åŠ¨

### macOS

```shell
$ mongod -f /etc/mongodb.conf
```

> **ï¼Tips**ï¼šæ³¨æ„é…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚

é‡å¯æœåŠ¡

- æ‰“å¼€mac å¯åŠ¨å° â†’ å…¶ä»– â†’ æ´»åŠ¨ç›‘è§†å™¨ â†’ åˆ é™¤ mongodb æœåŠ¡

- åœ¨ *`data/db/`* ç›®å½•ä¸‹åˆ é™¤ `mongod.lock` æ–‡ä»¶

- ç»ˆç«¯æ‰§è¡Œï¼š`mongod --repair`

- æ ¹æ®é…ç½®æ–‡ä»¶å¯åŠ¨ï¼š`mongod -f /etc/mongodb.conf`

### windows

æ‰“å¼€ç»ˆç«¯ï¼Œä»¥ **ç®¡ç†å‘˜èº«ä»½è¿è¡Œ**ï¼š

```shell
$ mongod -f "E:\MongoDB\bin\mongod.cfg" --serviceName "MongoDB" --install
```

```shell
# æŸ¥çœ‹æœåŠ¡
services.msc
# å¯ç”¨æœåŠ¡
net start MongoDB
# åœæ­¢æœåŠ¡
net stop MongoDB
```

> **Tipsï¼š** ä½¿ç”¨ç®¡ç†å‘˜æ¨¡å¼è¿è¡Œç»ˆç«¯ï¼Œåˆ‡è®°åˆ‡è®°ï¼

## 5. éªŒè¯

å¦‚æœå‡ºç° successful å°±è¡¨ç¤ºæœåŠ¡å·²ç»å¯åŠ¨æˆåŠŸ

æµè§ˆå™¨è¾“å…¥ï¼š

```
http://localhost:27017/
```

ç½‘é¡µå‘ˆç°å¦‚ä¸‹ä¿¡æ¯å³è¡¨ç¤ºæˆåŠŸï¼š

*It looks like you are trying to access MongoDB over HTTP on the native driver port.*

# ä¸‰ã€Databases and Collections

[å‚è€ƒæŒ‡å— >>](https://www.mongodb.com/docs/manual/core/databases-and-collections/)

> **æç¤ºï¼š**ç»ˆç«¯è¾“å…¥ `mongo` æŒ‡ä»¤å³å¯è¿›å…¥å‘½ä»¤æ¨¡å¼ã€‚

## 1. Databases

```mysql
# 1. æŸ¥çœ‹æ•°æ®åº“
show dbs 
# 2. åˆ›å»º/åˆ‡æ¢æ•°æ®åº“
use dbname
# 3. æŸ¥çœ‹å½“å‰æ•°æ®åº“
db
# 4. åˆ é™¤æ•°æ®åº“
db.dropDatabase()
# 5. æŸ¥çœ‹æœåŠ¡å™¨åœ°å€
db.getMongo()
```

> æç¤ºï¼šåˆšåˆ›å»ºçš„æ•°æ®åº“éœ€è¦æ’å…¥æ•°æ®æ‰èƒ½å¤Ÿæ˜¾ç¤ºã€‚

## 2. Collections

1ï¼‰å¸¸ç”¨æŒ‡ä»¤ï¼š

```mysql
# 1. åˆ›å»ºé›†åˆ
db.createCollection(name, options)
# 2. åˆ›å»ºé›†åˆå¹¶æ’å…¥ä¸€ä¸ªæ–‡æ¡£
db.COLLECTION_NAME.insert(document)
# 3. æŸ¥çœ‹é›†åˆ
show collections / show tables
# 4. åˆ é™¤é›†åˆ
db.COLLECTION_NAME.drop()
# 5. ä¿®æ”¹è¡¨å
db.COLLECTION_NAME.renameCollection("NEW_NAME");
# 6. æ¸…ç©ºè¡¨æ•°æ®
db.COLLECTION_NAME.remove({})
```

2ï¼‰ç¤ºä¾‹ï¼š

```shell
# åˆ›å»ºè¡¨
db.createCollection('usrs', {capped: true, size:6142800, max: 10000})
```

3ï¼‰é™„å½•è¯´æ˜ï¼š

åˆ›å»ºé›†åˆoptionsè¯´æ˜ï¼š

```typescript
interface Options {
  // â†’ æ˜¯å¦åˆ›å»ºã€Œå›ºå®šé›†åˆã€
  // â†’ å›ºå®šé›†åˆæ˜¯æŒ‡æœ‰ç€å›ºå®šå¤§å°çš„é›†åˆï¼Œå½“è¾¾åˆ°æœ€å¤§å€¼æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è¦†ç›–æœ€æ—©çš„æ–‡æ¡£ã€‚
  capped?: boolean; 
  // â†’ ä¸ºã€Œå›ºå®šé›†åˆã€æŒ‡å®šä¸€ä¸ªæœ€å¤§å€¼ï¼Œå•ä½ï¼šKB
  size?: number;
  // â†’ æŒ‡å®šã€Œå›ºå®šé›†åˆã€ä¸­åŒ…å«æ–‡æ¡£çš„æœ€å¤§æ•°é‡
  max?: number;
  // â†’ æ˜¯å¦ä¸ºã€Œ_idã€å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸º falseï¼Œv3.2 ä¹‹åä¸å†æ”¯æŒè¯¥å‚æ•°
  autoIndexId?: boolean;
}
```

> æç¤ºï¼š
>
> - åœ¨æ’å…¥æ–‡æ¡£æ—¶ï¼ŒMongoDB é¦–å…ˆæ£€æŸ¥å›ºå®šé›†åˆçš„ size å­—æ®µï¼Œç„¶åæ£€æŸ¥ max å­—æ®µï¼Œç„¶åautoIndexIdå±æ€§å·²ç»è¢«é—å¼ƒäº†ï¼Œæœªæ¥å°†ä¼šè¢«åˆ é™¤ã€‚
> - åœ¨ MongoDB ä¸­ï¼Œå…¶å®å½“ä½ æ’å…¥ä¸€äº›æ–‡æ¡£æ—¶ï¼ŒMongoDB ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºé›†åˆã€‚

# å››ã€CURD

```mysql
# åˆ›å»ºæ•°æ®åº“ â†’ dbNameï¼šmanual
use manual
```

## 1. æ’å…¥æ–‡æ¡£

è¯­æ³•ï¼š

```mysql
# æ’å…¥å•ä¸ªæ–‡æ¡£
db.<collection-name>.insertOne(document)
# æ’å…¥å¤šä¸ªæ–‡æ¡£
db.<collection-name>.insertMany([document...])
```

ç¤ºä¾‹ä»£ç ï¼š

```mysql
# æ’å…¥å½“ä¸ªæ–‡æ¡£
db.examples.insertOne({name: "æé¸¿è€€", job: "æ‰“å·¥äºº" });
# æ’å…¥å¤šä¸ªæ–‡æ¡£
db.examples.insertMany([
	{ name: "é©¬åŒ–è…¾", job: "è…¾è®¯CEO" },
	{ name: "é©¬äº‘", job: "é˜¿é‡Œå·´å·´CEO" }
])
# æŸ¥è¯¢æ•°æ®
db.example.find({})
```

![](./images/insert_example.png)

> **ï¼Tipsï¼š**
>
> - æ’å…¥æ–‡æ¡£æ—¶å¦‚æœæ²¡æœ‰æŒ‡å®š `id`ï¼ŒMongoDB ä¼šè‡ªåŠ¨ç”Ÿæˆ `_id`ï¼Œç±»å‹ä¸º `ObjectId`
> - å½“ä½ ç›´æ¥æ‰§è¡Œæ’å…¥æ–‡æ¡£çš„æ“ä½œï¼Œå¦‚æœæ•°æ®åº“æ²¡æœ‰å¯¹åº”çš„è¡¨ï¼Œä¼šä¸ºä½ è‡ªåŠ¨åˆ›å»ºã€‚

## 2. æŸ¥è¯¢æ–‡æ¡£

### åŸºç¡€æŸ¥è¯¢

ç¤ºä¾‹æ•°æ®ï¼š

```mysql
db.examples.insertMany([
	{name: "å‘¨æ°ä¼¦", sex: "ç”·", age: 40, tags: ["æ­Œæ‰‹"], score: { chinese: 58, english:ã€€80 } },
	{name: "è°¢éœ†é”‹", sex: "ç”·", age: 43, tags: ["æ­Œæ‰‹", "æ¼”å‘˜", "å¨å¸ˆ"], score: { chinese: 76, english:ã€€90 } },
	{name: "å¼ å­¦å‹", sex: "ç”·", age: 56, tags: ["æ­Œæ‰‹", "æ¼”å‘˜"], score: { chinese: 80, english:ã€€92 } },
	{name: "åˆ˜å¾·å", sex: "ç”·", age: 64, tags: ["æ­Œæ‰‹", "æ¼”å‘˜", "æ…ˆå–„å®¶"], score: { chinese: 76, english:ã€€90 } },
	{name: "è”¡ä¾æ—", sex: "å¥³", age: 43, tags: ["æ­Œæ‰‹", "èˆè€…"], score: { chinese: 68, english:ã€€83 } },
	{name: "å†¯å°åˆš", sex: "ç”·", age: 60, tags: ["å¯¼æ¼”", "æ¼”å‘˜"], score: { chinese: 79, english:ã€€68 } },
	{name: "ç™½å²©æ¾", sex: "ç”·", age: 63, tags: ["ä¸»æŒäºº"], score: { chinese: 98, english:ã€€87 } },
	{name: "æé¸¿è€€", sex: "ç”·", age: 30, tags: ["æ‰“å·¥äºº"], score: { chinese: 82, english:ã€€60 } },
	{name: "è‘£æ˜ç ", sex: "å¥³", age: 58, tags: ["ä¼ä¸šå®¶"], score: { chinese: 84, english:ã€€88 } },
	{name: "æ’’è´å®", sex: "ç”·", age: 46, tags: ["ä¸»æŒäºº"], score: { chinese: 100, english:ã€€93 } },
]);
```

ä»£ç ç¤ºä¾‹ï¼š

- æŸ¥è¯¢æ‰€æœ‰æ•°æ®

  ```mysql
  db.examples.find();
  ```

  ![](./images/find-eg-1.png)

- æŸ¥è¯¢ sex = â€™ç”·â€˜ çš„æ•°æ®

  ```mysql
  db.examples.find({sex: "ç”·"});
  ```

  ![](./images/find-eg-2.png)

- $in â†’ æŸ¥è¯¢å§“åä¸ºâ€™è°¢éœ†é”‹â€˜ æˆ–è€… â€è¯¸è‘›äº®â€œ çš„è®°å½•

  ```mysql
  db.examples.find({ name: { $in: ["è°¢éœ†é”‹", "è¯¸è‘›äº®" ]}});
  ```

  ![](./images/find-eg-3.png)

- $and â†’ æŸ¥è¯¢å¹´é¾„å¤§äºç­‰äº60çš„ç”·æ€§

  ```mysql
  db.examples.find({ sex: "ç”·", age: { $gte: 60 }});
  ```

  ![](./images/find-eg-4.png)

- $or â†’ æŸ¥è¯¢æ€§åˆ«ä¸ºå¥³ æˆ–è€… å¹´é¾„å¤§äº60çš„æ•°æ®

  ```mysql
  db.examples.find({ $or: [ {sex: "å¥³"}, {age: {$gt: 60}}]});
  ```

  ![](./images/find-eg-5.png)

- \$or + $And â†’ æŸ¥è¯¢æ€§åˆ«ä¸ºç”·ï¼Œå¹¶ä¸”å¹´é¾„å°äºç­‰äº30æˆ–è€…è¯­æ–‡æˆç»©å¤§äº90çš„æ•°æ®

  ```mysql
  db.examples.find({ 
  	sex: "ç”·",
  	$or: [{ age: {$lte: 30}}, {"score.chinese": {$gt: 90}}]
  });
  ```
  
  ![](./images/find-eg-6.png)

### æ•°ç»„æŸ¥è¯¢

- æŸ¥è¯¢ tags ç­‰äº ["æ­Œæ‰‹", "æ¼”å‘˜"] çš„æ•°æ®ï¼ˆå…ƒç´ å’Œé¡ºåºä¸€è‡´ï¼‰

  ```mysql
  db.examples.find({ tags: ["æ­Œæ‰‹", "æ¼”å‘˜"]});
  ```

  ![](./images/find-eg-7.png)

  

- $all â†’ æŸ¥è¯¢åªè¦ tags åŒ…å« æ­Œæ‰‹ å’Œ æ¼”å‘˜ çš„æ•°æ®

  ```mysql
  db.examples.find({ tags: {$all: ["æ­Œæ‰‹", "æ¼”å‘˜"]}});
  ```

  ![](./images/find-eg-8.png)

- æŸ¥è¯¢ tags åŒ…å« æ¼”å‘˜çš„æ•°æ®ï¼Œåªè¦æœ‰æ¼”å‘˜å°±è¿”å›ï¼š

  ```mysql
  db.examples.find({ tags: "æ¼”å‘˜"});
  ```
  
  ![](./images/find-eg-9.png)

### æ•°æ®æ˜ å°„

é€šè¿‡è®¾ç½® `find` çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ§åˆ¶æ˜¯å¦è¿”å›æŸäº›åˆ—ï¼Œ`0`ï¼šéšè— / `1`ï¼šæ˜¾ç¤º

- æŒ‡å®šè¿”å›å­—æ®µï¼Œæ¯”å¦‚åªè¿”å› name/sex/age

  ```mysql
  db.examples.find({}, { name: 1, sex: 1, age: 1});
  ```

  ![](./images/find-map-1.png)

- éšè— `_id` å­—æ®µ

  ```mysql
  db.examples.find({}, { _id: 0, name: 1, sex: 1, age: 1});
  ```

  ![](./images/find-map-2.png)

- å»é™¤æŒ‡å®šå­—æ®µï¼Œæ¯”å¦‚ç¤ºä¾‹ä¸­æˆ‘ä»¬å»é™¤ `tags` å­—æ®µï¼Œæœªè®¾ç½®çš„å°†ä¼šæ˜¾ç¤º

  ```mysql
  db.examples.find({}, { tags: 0 });
  ```

  ![](./images/find-map-3.png)

- æ˜ å°„è¿”å›æ•°ç»„ä¸­æŒ‡å®šçš„æ•°ç»„å…ƒç´ ï¼Œ$slice è¡¨ç¤ºæˆªå–å…ƒç´ ï¼Œå€¼ä¸ºæˆªå–ä¸ªæ•°ï¼Œè´Ÿæ•°è¡¨ç¤ºä»åå¾€å‰æˆªå–ï¼Œæ­£æ•°è¡¨ç¤ºä»å‰å¾€åæˆªå–ã€‚

  å¦‚ä¸‹ç¤ºä¾‹æŸ¥è¯¢è°¢éœ†é”‹çš„è®°å½•ï¼Œå¹¶ä¸”éšè— `_id` `score` `age`ï¼Œå…¶ä¸­ `tags` åªè¿”å›åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªæ•°æ®ã€‚

  ```mysql
  db.examples.find(
  	{name: "è°¢éœ†é”‹"},
  	{_id: 0, tags: {$slice: -1}, score: 0, age: 0 }
  );
  ```
  
  ![](./images/find-map-4.png)
  
  

> `ï¼Tips`
>
> - é™¤ `_id` å­—æ®µå¤–ï¼Œä¸èƒ½åœ¨æ˜ å°„æ–‡æ¡£ä¸­åŒæ—¶ä½¿ç”¨ **åŒ…å«** å’Œ **å»é™¤** è¯­å¥ã€‚å³ `0` å’Œ `1` ä¸èƒ½åŒæ—¶å­˜åœ¨ã€‚

## 3. æ›´æ–°æ–‡æ¡£

æ’å…¥æ–‡æ¡£Apisï¼š

- [`db.collection.updateOne(<filter>, <update>, <options>)`](https://www.mongodb.com/docs/manual/reference/method/db.collection.updateOne/#mongodb-method-db.collection.updateOne)
- [`db.collection.updateMany(<filter>, <update>, <options>)`](https://www.mongodb.com/docs/manual/reference/method/db.collection.updateMany/#mongodb-method-db.collection.updateMany)
- [`db.collection.replaceOne(<filter>, <update>, <options>)`](https://www.mongodb.com/docs/manual/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne)

è¯­æ³•è§£è¯»ï¼š

- `<query>` ï¼šæŸ¥è¯¢æ¡ä»¶
- `<update>`ï¼šæ›´æ–°åçš„å¯¹è±¡æˆ–æŒ‡å®šä¸€äº›æ›´æ–°çš„æ“ä½œç¬¦
- `<options>`ï¼šå¯é€‰é¡¹
  - `upsert`ï¼šå¯é€‰ï¼ŒæœªæŸ¥è¯¢åˆ°æ—¶æ˜¯å¦æ’å…¥updateObjï¼Œé»˜è®¤falseã€‚
  - `multi`ï¼šå¯é€‰ï¼Œæ˜¯å¦æ›´æ–°æ‰€æœ‰æŸ¥è¯¢åˆ°çš„æ–‡æ¡£ï¼Œé»˜è®¤ falseã€‚

ä¸€èˆ¬æ¥è®²ï¼Œæ›´æ–°æ•°æ®å¯ä½¿ç”¨ æ“ä½œç¬¦ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

### $set &  \$unset

**ğŸ‘‰ `$set`ï¼šæ›´æ–°å­—æ®µ**

```mysql
db.examples.update(
	{name: "å‘¨æ°ä¼¦"},     
	{ 
		$set: { age: 30 }, 
		$currentDate: { lastModified: true } 
	}
)
```

> **æç¤ºï¼š** `$currentDate` è¡¨ç¤ºè·å–å½“å‰æ—¶é—´ã€‚

**ğŸ‘‰ `$unset`ï¼šåˆ é™¤å­—æ®µ/åˆ—**

ä¸‹é¢ç¤ºä¾‹ä¸­ï¼Œè¡¨ç¤ºåˆ é™¤ â€œupdateTimeâ€ åˆ—ã€‚

```mysql
db.examples.update({}, { $unset: { updateTime: "" }})
```

### $inc

åœ¨åŸåŸºç¡€ä¸Šç´¯åŠ ï¼š

```mysql
db.examples.update(
	{name: "å‘¨æ°ä¼¦"},
	{ 
		$inc: { age: 10 },
		$currentDate: { lastModified: true }
	}
)
```

ä»£ç æè¿°ï¼šæŸ¥è¯¢ name ä¸ºå‘¨æ°ä¼¦çš„è®°å½•ï¼Œå¹¶å°†å…¶ age å­—æ®µç´¯åŠ 10

### $push

å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ ï¼Œä¸ä¼šè¦†ç›–å·²æœ‰çš„

```js
{ $push: { <field1>: <value1>, ... } }
```

```mysql
db.examples.update(
	{name: "å‘¨æ°ä¼¦"},     
	{ 
		$push: { interest: "å”±æ­Œ" }
	}
)
```

### $addToSet

ç»™æ•°ç»„æ·»åŠ æˆ–è€…è®¾ç½®ä¸€ä¸ªå€¼

```js
{ $addToSet: { <field1>: <value1>, ... } }
```

ç¤ºä¾‹1ï¼šä¸º â€œå‘¨æ°ä¼¦â€ çš„ tags æ·»åŠ  â€œæ¼”å‘˜â€

```mysql
db.examples.update(
	{name: "å‘¨æ°ä¼¦"},     
	{ 
		$addToSet: { tags: "æ¼”å‘˜" }
	}
)
```

## 4. åˆ é™¤æ–‡æ¡£

```mysql
# 1. åˆ é™¤å•ä¸ªæ–‡æ¡£
db.<COLLECTION_NAME>.deleteOne(filter, options)
# 2. åˆ é™¤å¤šä¸ªæ–‡æ¡£
db.<COLLECTION_NAME>.deleteMany(filter, options)
# 3. æŸ¥è¯¢å¹¶ç§»é™¤
db.<COLLECTION_NAME>.remove(query, options)
```

# äº”ã€èšåˆç®¡é“ - æ ¸å¿ƒ

[èšåˆç®¡é“æ“ä½œç¬¦ >>](https://www.mongodb.com/docs/manual/reference/operator/aggregation/)

æŸ¥è¯¢æ–‡æ¡£å¯ä»¥ä½¿ç”¨ `.find()` æ–¹æ³•ï¼Œè¿™é‡Œä¸»è¦æ¨èé«˜çº§ç”¨æ³•ï¼šèšåˆç®¡é“æŸ¥è¯¢ â†’ [aggregation >>](https://www.mongodb.com/docs/manual/aggregation/)

èšåˆç®¡é“ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†æ–‡æ¡£çš„é˜¶æ®µç»„æˆï¼š

- æ¯ä¸ªé˜¶æ®µå¯¹è¾“å…¥æ–‡æ¡£æ‰§è¡Œä¸€ä¸ªæ“ä½œã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªstageå¯ä»¥è¿‡æ»¤æ–‡æ¡£ã€åˆ†ç»„æ–‡æ¡£å’Œè®¡ç®—å€¼ã€‚
- ä»ä¸€ä¸ªé˜¶æ®µè¾“å‡ºçš„æ–‡æ¡£è¢«ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚
- èšåˆç®¡é“å¯ä»¥è¿”å›æ–‡æ¡£ç»„çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œè¿”å›æ€»å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼å’Œæœ€å°å€¼ã€‚

é€šè¿‡è¿™å¼ å›¾ï¼Œå¯ä»¥äº†è§£Aggregateå¤„ç†çš„è¿‡ç¨‹

<img src="./images/aggregation.png" style="zoom:70%;" />

## 1. Apis

èšåˆç®¡é“ä¸»è¦åŒ…å«å¦‚ä¸‹APIï¼š

| å‘½ä»¤                                                         | åŠŸèƒ½æè¿°                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`$match`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match) | ç”¨äºè¿‡æ»¤æ•°æ®ï¼Œåªè¾“å‡ºç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ï¼Œä¸ `find()` ç±»ä¼¼ï¼ŒåŸºäºMongoDBçš„æ ‡å‡†æŸ¥è¯¢æ“ä½œ |
| [`$group`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/#mongodb-pipeline-pipe.-group) | å°†é›†åˆä¸­çš„æ–‡æ¡£åˆ†ç»„ï¼Œå¯ç”¨äºç»Ÿè®¡ç»“æœ                           |
| [`$project`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project) | ä¿®æ”¹è¾“å…¥æ–‡æ¡£çš„ç»“æ„ã€‚å¯ä»¥ç”¨æ¥é‡å‘½åã€å¢åŠ æˆ–åˆ é™¤åŸŸï¼Œä¹Ÿå¯ä»¥ç”¨äºåˆ›å»ºè®¡ç®—ç»“æœä»¥åŠåµŒå¥—æ–‡æ¡£ |
| [`$skip`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/skip/#mongodb-pipeline-pipe.-skip) | åœ¨èšåˆç®¡é“ä¸­è·³è¿‡æŒ‡å®šæ•°é‡çš„æ–‡æ¡£                               |
| [`$limit`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/limit/#mongodb-pipeline-pipe.-limit) | ç”¨æ¥é™åˆ¶MongoDBèšåˆç®¡é“è¿”å›çš„æ–‡æ¡£æ•°                          |
| [`$unwind`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/unwind/#mongodb-pipeline-pipe.-unwind) | å°†æ–‡æ¡£ä¸­çš„æŸä¸€ä¸ªæ•°ç»„ç±»å‹å­—æ®µæ‹†åˆ†æˆå¤šæ¡ï¼Œæ¯æ¡åŒ…å«æ•°ç»„ä¸­çš„ä¸€ä¸ªå€¼ |
| [`$lookup`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/#mongodb-pipeline-pipe.-lookup) | å¼•å…¥å…¶ä»–é›†åˆçš„æ•°æ®ï¼ˆè¡¨å…³è”æŸ¥è¯¢ï¼‰                             |
| [`$sort`](https://www.mongodb.com/docs/manual/reference/operator/aggregation/sort/#mongodb-pipeline-pipe.-sort) | å°†è¾“å…¥æ–‡æ¡£æ’åºåè¾“å‡º *`1`ï¼šå‡åºï¼Œ`-1`ï¼šé™åºï¼Œé»˜è®¤ä¸ºå‡åºæ˜¾ç¤º* |
| [`$rank`](https://www.mongodb.com/docs/v5.0/reference/operator/aggregation/rank/#mongodb-group-grp.-rank) / [`$denseRank`](https://www.mongodb.com/docs/v5.0/reference/operator/aggregation/denseRank/#mongodb-group-grp.-denseRank) | æ’åæŸ¥è¯¢                                                     |

> **Tipsï¼š**åŒæ ·çš„æ“ä½œç¬¦ä»¥åŠæ¡ä»¶, ä¸åŒçš„æ’åˆ—é¡ºåºå¯¹æŸ¥è¯¢ç»“æœä¼šæœ‰å½±å“

## 2. å•ä¸€ç”¨é€”èšåˆæ–¹æ³•

å•ä¸€ç”¨é€”èšåˆæ–¹æ³•ä»å•ä¸ªé›†åˆèšåˆæ–‡æ¡£ã€‚è¿™äº›æ–¹æ³•å¾ˆç®€å•ï¼Œä½†ç¼ºä¹èšåˆç®¡é“çš„åŠŸèƒ½ã€‚

- [`db.collection.count()`](https://www.mongodb.com/docs/manual/reference/method/db.collection.count/#mongodb-method-db.collection.count)ï¼šè¿”å›é›†åˆæˆ–è§†å›¾ä¸­æ–‡æ¡£æ•°é‡çš„è®¡æ•°

## 3. æ‰©å±•ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå…°å·æ‹‰é¢è®¢å•ç»Ÿè®¡

æ’å…¥ç¤ºä¾‹æ•°æ®ï¼š

```mysql
db.examples.insertMany([
	{ name: "å­œç„¶ç‰›è‚‰æ‹Œé¢", size: "ä¸­ä»½", nums: 3, price: 16, date: "2022/01/01" },
	{ name: "çº¢çƒ§ç‰›è‚‰æ‹Œé¢", size: "ä¸­ä»½", nums: 2, price: 16, date: "2022/01/01" },
	{ name: "è‘±çˆ†ç‰›è‚‰æ‹Œé¢", size: "å°ä»½", nums: 6, price: 14, date: "2022/01/01" },
	{ name: "è‘±çˆ†ç‰›è‚‰æ‹Œé¢", size: "å¤§ä»½", nums: 3, price: 18, date: "2022/01/02" },
	{ name: "è¾£å­é¸¡å—æ‹Œé¢", size: "ä¸­ä»½", nums: 9, price: 16, date: "2022/01/02" },
	{ name: "é’æ¤’ç‚’è›‹æ‹Œé¢", size: "ä¸­ä»½", nums: 2, price: 13, date: "2022/01/02" },
	{ name: "æ´‹è‘±ç‚’è‚‰æ‹Œé¢", size: "ä¸­ä»½", nums: 4, price: 14, date: "2022/01/02" },
	{ name: "å­œç„¶ç‰›è‚‰æ‹Œé¢", size: "å°ä»½", nums: 3, price: 14, date: "2022/01/03" },
	{ name: "è‚‰æœ«èŒ„å­æ‹Œé¢", size: "ä¸­ä»½", nums: 5, price: 14, date: "2022/01/03" },
	{ name: "çº¢çƒ§ç‰›è‚‰æ‹Œé¢", size: "ä¸­ä»½", nums: 2, price: 16, date: "2022/01/04" },
	{ name: "è‚‰æœ«èŒ„å­æ‹Œé¢", size: "ä¸­ä»½", nums: 8, price: 16, date: "2022/01/04" },
	{ name: "å­œç„¶ç‰›è‚‰æ‹Œé¢", size: "ä¸­ä»½", nums: 1, price: 16, date: "2022/01/04" },
])
```

#### ğŸ‘‰ ç»Ÿè®¡ä¸­ä»½æ‹Œé¢å„ç±»å‹çš„é”€å”®ä»½æ•°

æ‰§è¡Œä»£ç ï¼š

```mysql
db.examples.aggregate([
	// Stage 1ï¼šè¿‡æ»¤ä¸­ä»½æ‹Œé¢
	{ $match: { size: "ä¸­ä»½" } },
	// Stage 2ï¼šæŒ‰ç…§æ‹Œé¢ç±»å‹(name)åˆ†ç»„ï¼Œå¹¶è®¡ç®—é”€é‡(nums)
	{ $group: { _id: "$name", totalNums: {$sum: "$nums" }  }},
	// State 3ï¼šæ ¼å¼åŒ–è¾“å‡ºï¼Œå°† _id é‡å‘½åä¸º name è¾“å‡º
	{ $project: { _id: 0, name: "$_id", totalNums: 1  }}		
])
```

- `$match` statgeï¼š
  - å°†è®¢å•è®°å½•è¿‡æ»¤ä¸º **ä¸­ä»½** çš„æ•°æ®
  - å°†å‰©ä½™çš„æ–‡æ¡£ä¼ é€’åˆ°$groupé˜¶æ®µã€‚
- `$group` stageï¼š
  - å°†å…¶ä½™æ–‡æ¡£æŒ‰æ‹Œé¢åç§° `name` åˆ†ç»„ã€‚
  - ä½¿ç”¨ `$sum` è®¡ç®—æ¯ä¸ªæ‹Œé¢åç§°çš„æ€»è®¢å•é‡ã€‚æ€»æ•°å­˜å‚¨åœ¨èšåˆç®¡é“è¿”å›çš„ `totalOrderNums` å­—æ®µä¸­ã€‚
- `$project` stageï¼š
  - æŒ‡å®šè¾“å‡ºæ–‡æ¡£ï¼Œéšè— `_id`ï¼Œå¹¶å°† `name` æŒ‡å‘ `_id` æ˜¾ç¤ºã€‚

è¾“å‡ºç»“æœï¼š

```js
// 1
{ "name": "å­œç„¶ç‰›è‚‰æ‹Œé¢", "totalNums": 7 }

// 2
{ "name": "æ´‹è‘±ç‚’è‚‰æ‹Œé¢", "totalNums": 4 }

// 3
{ "name": "çº¢çƒ§ç‰›è‚‰æ‹Œé¢", "totalNums": 4 }

// 4
{ "name": "è¾£å­é¸¡å—æ‹Œé¢", "totalNums": 11}

// 5
{ "name": "è‚‰æœ«èŒ„å­æ‹Œé¢", "totalNums": 13}
```

#### ğŸ‘‰ è®¡ç®—æ€»è®¢å•å€¼å’Œå¹³å‡è®¢å•æ•°é‡

æµ‹è¯•æ•°æ®

```mysql
db.examples.aggregate([
    // Stage 1ï¼šè¿‡æ»¤ä¸­ä»½æ‹Œé¢
    { $match: { size: "ä¸­ä»½" } },
    // Stage 2ï¼šæ ¹æ®æ—¥æœŸè¿›è¡Œåˆ†ç»„ï¼Œç„¶åç»Ÿè®¡å½“å¤©çš„é”€å”®æ€»é¢å’Œå¹³å‡å–å‡ºçš„ä»½æ•°
    { $group: { 
				_id: "$date", 
				totalOrderPrice: {$sum: { $multiply: [ "$price", "$nums" ] } },
				averageOrderNums: { $avg: "$nums" }
		}},
		// Stage 3ï¼šç»“æœé™åºè¾“å‡º		
		{ $sort: { totalOrderPrice: -1 }},
		// Stage 4ï¼šæ ¼å¼åŒ–è¾“å‡º 
		{ $project: { _id: 0, date: "$_id", totalOrderPrice: 1, averageOrderNums: 1} }
])
```

### ç¤ºä¾‹2ï¼šæ’å

ç¤ºä¾‹æ•°æ®ï¼š

```mysql
db.examples.insertMany([
  {name: "åˆ˜å¾·å", sex: "ç”·", age: 64, score: 93 },
	{name: "å‘¨æ°ä¼¦", sex: "ç”·", age: 39, score: 90 },
	{name: "æ—ä¿Šæ°", sex: "ç”·", age: 36, score: 88 },
	{name: "ç½—å¿—ç¥¥", sex: "ç”·", age: 34, score: 60 },
	{name: "è”¡ä¾æ—", sex: "å¥³", age: 35, score: 76 },
	{name: "ç‹åŠ›å®", sex: "ç”·", age: 38, score: 84 },
	{name: "å¼ å­¦å‹", sex: "ç”·", age: 65, score: 90 },
	{name: "é‚“ç´«æ£‹", sex: "å¥³", age: 35, score: 88 },
])
```

#### ğŸ‘‰ æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„æ’å

æ€è·¯ï¼šæ’åº â†’ æŸ¥æ‰¾

èšåˆï¼š`$indexOfArray` / `$group` / `$project `

éœ€æ±‚ï¼šæŸ¥è¯¢ç‹åŠ›å®çš„æ’å

```mysql
db.examples.aggregate([
	// Stage 1ï¼šæ ¹æ® score é™åºæ’åº
	{ $sort: { score: -1 }}, 
	// Stage 2ï¼šåˆ†ç»„æ•°æ®
	{ $group: { _id: null, all: { $push: "$name" }} }, 
	// State 3ï¼šæ ¼å¼åŒ–è¾“å‡º	
	{ $project: { _id: 0, total: { $size: "$all" }, rank: { $indexOfArray: ["$all",  "ç‹åŠ›å®"] }}}
])
```

æ ¹æ® ObjectId æ¥æŸ¥è¯¢æ’åï¼š

```mysql
db.examples.aggregate([
	// Stage 1ï¼šæ ¹æ® score é™åºæ’åº
	{ $sort: { score: -1 }}, 
	// Stage 2ï¼šåˆ†ç»„æ•°æ®
	{ $group: { _id: null, all: { $push: "$_id" }} }, 
	// State 3ï¼šæ ¼å¼åŒ–è¾“å‡º	
	{ $project: { _id: 0, total: { $size: "$all" }, rank: { $indexOfArray: ["$all",  ObjectId(idString)] }}}
])
```

#### ğŸ‘‰ $rank

```mysql
db.examples.aggregate([
	{
		$setWindowFields: {
			// æ ¹æ®sexåˆ†ç»„æ’åï¼Œå³ç”·ç”Ÿå’Œç”·ç”Ÿæ’åï¼Œå¥³ç”Ÿå’Œå¥³ç”Ÿæ’å
			partitionBy: "$sex",
			// æ ¹æ®scoreæ’åºï¼Œæ’åä¾æ®
			sortBy: { score: -1 },
			// è¾“å‡ºæ’å
			output: {
				// æ’åæ˜¾ç¤ºå­—æ®µå
				rankScoreForSex: {
						// å¹¶åˆ—åå­—æ’å
						$denseRank: {}
				}
			}
		}
	},
])
```

### ç¤ºä¾‹3ï¼šå…³è”æŸ¥è¯¢

ç°æœ‰å¦‚ä¸‹ä¸¤å¼ è¡¨ï¼š

```ini
# schoolsè¡¨
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": ObjectId("62952860f542cf6c844e3133"),
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001"
}
# studentsè¡¨
{ "_id": ObjectId("62952860f542cf6c844e3133"), "name": "å¼ ä¸‰", "phone": "15666666666", "major": "è½¯ä»¶å·¥ç¨‹" },
{ "_id": ObjectId("62952860f542cf6c844e3134"), "name": "æå››", "phone": "15777777777", "major": "ç”µå­å•†åŠ¡" },
{ "_id": ObjectId("62952860f542cf6c844e3135"), "name": "èµµäºŒ", "phone": "15888888888", "major": "ç½‘ç»œå·¥ç¨‹" }
```

æŸ¥è¯¢ `schools` è¡¨ï¼Œå¹¶æ ¹æ® `studentId` æŸ¥è¯¢å­¦ç”Ÿè¡¨ï¼š

#### ğŸ‘‰ å…³è”å­—æ®µç±»å‹ä¸€è‡´æ—¶

å…³è”å­—æ®µç±»å‹ä¸€ç›´è¡¨ç¤ºä¸¤è¡Œè¡¨å…³è”å­—æ®µå€¼ç±»å‹ä¸€ç›´ï¼Œæ¯”å¦‚ schools.studentId å’Œ students._id ç±»å‹ä¸€è‡´ï¼Œéƒ½æ˜¯ObjectIdã€‚

```mysql
db.schools.aggregate([
	{ $match: {} },
	{ $lookup: { 
		from: "students",  // â†’ æ¥æºï¼Œå³å…³è”å“ªå¼ è¡¨
		localField: "studentId", // â†’ å½“å‰è¡¨å…³è”å­—æ®µ
		foreignField: "_id", // â†’ æ¥æºè¡¨å…³è”å­—æ®µ
		as: "student" // â†’ è¾“å‡ºå­—æ®µ
	}}
])
```

æŸ¥è¯¢ç»“æœï¼š

```json
// 1
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": ObjectId("62952860f542cf6c844e3133"),
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001",
    "student": [
        {
            "_id": ObjectId("62952860f542cf6c844e3133"),
            "name": "å¼ ä¸‰",
            "phone": "15666666666",
            "major": "è½¯ä»¶å·¥ç¨‹"
        }
    ]
}
```

> **ï¼æç¤º**ï¼šç”±ä»¥ä¸Šçš„åˆ†æå¯çŸ¥ï¼Œå…³è”æŸ¥è¯¢æ—¶å¦‚æœä¸¤ä¸ªè¡¨çš„å­—æ®µç±»å‹ä¸€è‡´ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `$lookup` è¿›è¡Œå…³è”æŸ¥è¯¢æ“ä½œã€‚

#### ğŸ‘‰ å…³è”å­—æ®µç±»å‹ä¸ä¸€è‡´æ—¶

ç°åœ¨å°†ä¸Šè¿°ç¤ºä¾‹ä¸­ `schools` è¡¨ä¸­çš„æ•°æ®æ”¹ä¸ºå¦‚ä¸‹ï¼š

```json
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": "62952860f542cf6c844e3133", // studentIdä¸ºstringç±»å‹
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001"
}
```

ç°åœ¨ï¼Œ`schools` è¡¨ä¸­çš„ `studentId` ç±»å‹ä¸º `string` ç±»å‹ï¼Œè€Œå­¦ç”Ÿè¡¨ä¸­çš„ `_id`ä¸º `ObjectId` ç±»å‹ã€‚å¯¹äºè¿™ç§æƒ…å†µä¸‹å¦‚æœè¿˜æ˜¯ä½¿ç”¨ä¸Šè¿°çš„æ–¹å¼æ¥æŸ¥è¯¢æ•°æ®ï¼ŒæŸ¥è¯¢åˆ°çš„ç»“æœä¸ºï¼š

```json
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": "62952860f542cf6c844e3133",
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001",
    "student": [ ]
}
```

è¿™ç§æƒ…å†µä¸‹éœ€è¦ä½¿ç”¨ `$addFields`ï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š

```mysql
db.schools.aggregate([
	{ $match: {} },
	{ $addFields: { stuId: { $toObjectId: "$studentId" } }},
	{ $lookup: { 
		from: "students", 
		localField: "stuId",
		foreignField: "_id",
		as: "student"
	}}
])
```

> **ï¼æç¤º**ï¼šå¦‚æœæ˜¯ `ObjectId` è½¬åŒ–ä¸º `String`ï¼Œå°† `$toObjectId` æ”¹ä¸º `$toString`ã€‚

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```json
// 1
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": ObjectId("62952860f542cf6c844e3133"),
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001",
    "stuId": ObjectId("62952860f542cf6c844e3133"),
    "student": [
        {
            "_id": ObjectId("62952860f542cf6c844e3133"),
            "name": "å¼ ä¸‰",
            "phone": "15666666666",
            "major": "è½¯ä»¶å·¥ç¨‹"
        }
    ]
}
```

#### ğŸ‘‰ å±•å¼€å…³è”æ•°æ®

å¯¹äºä¸Šè¿°çš„æ“ä½œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºåœ¨ä¸Šè¿°çš„æ“ä½œä¸­å…³è”æŸ¥è¯¢ä¹‹åçš„ `student` ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨æ•°ç»„çš„æ–¹å¼å‘ˆç°ï¼Œå¯ä»¥ä½¿ç”¨ `$unwind` å°†æ•°ç»„æ‰“æ•£æ¥å‘ˆç°ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

```mysql
db.schools.aggregate([
	{ $match: {} },
	{ $addFields: { stuId: { $toObjectId: "$studentId" } }},
	{ $lookup: { 
		from: "students", 
		localField: "stuId",
		foreignField: "_id",
		as: "student"
	}},
	{ $unwind: "$student" }
])
```

å‘ˆç°çš„æ•ˆæœå¦‚ä¸‹ï¼š

```json
// 1
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "studentId": ObjectId("62952860f542cf6c844e3133"),
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001",
    "stuId": ObjectId("62952860f542cf6c844e3133"),
    "student": {
        "_id": ObjectId("62952860f542cf6c844e3133"),
        "name": "å¼ ä¸‰",
        "phone": "15666666666",
        "major": "è½¯ä»¶å·¥ç¨‹"
    }
}
```

ä½†æ˜¯è¿™æ ·çš„è¯ï¼ŒåŸæœ¬åªæœ‰ä¸€æ¡æ•°æ®ï¼Œä½†æ˜¯æ‹†åˆ†ä»¥åè·å–åˆ°çš„æ•°æ®ä¸ªæ•°å°±æ˜¯ `student` æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µæ¥é€‰æ‹©ï¼åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æŠŠ `student` ä¸­çš„å­—æ®µå†æ¬¡æ‰“æ•£ï¼Œä½¿å…¶å’Œ `student` æ•°æ®ç»“æ„åœ¨åŒä¸€çº§åˆ«ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ `$project` å®ç°ï¼Œæ“ä½œå¦‚ä¸‹ï¼š

```mysql
db.schools.aggregate([
	{ $match: {} },
	{ $addFields: { stuId: { $toObjectId: "$studentId" } }},
	{ $lookup: { 
		from: "students", 
		localField: "stuId",
		foreignField: "_id",
		as: "student"
	}},
	{ $unwind: "$student" },
	{ $project: { 
		stuName: "$student.name",  
		stuPhone: "$student.phone",
		stuMajor: "$student.major",
		name: 1,
		address: 1,
		phone: 1
	}}
])
```

æ­¤æ—¶ï¼Œå‘ˆç°ç»“æœä¸ºï¼š

```json
// 1
{
    "_id": ObjectId("62952aa6f542cf6c844e3136"),
    "name": "æˆéƒ½ä¸œè½¯å­¦é™¢",
    "address": "å››å·çœæˆéƒ½å¸‚éƒ½æ±Ÿå °å¸‚é’åŸå±±åŒºä¸œè½¯å¤§é“1å·",
    "phone": "028-64888001",
    "stuName": "å¼ ä¸‰",
    "stuPhone": "15666666666",
    "stuMajor": "è½¯ä»¶å·¥ç¨‹"
}
```

# å…­ã€ ç´¢å¼•

### 6.1. æ¦‚è¿°

ç´¢å¼•é€šå¸¸èƒ½å¤Ÿæå¤§çš„æé«˜æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒMongoDB åœ¨è¯»å–æ•°æ®æ—¶å¿…é¡»æ‰«æé›†åˆä¸­çš„æ¯ä¸ªæ–‡ä»¶å¹¶é€‰å–é‚£äº›ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•ã€‚

è¿™ç§æ‰«æå…¨é›†åˆçš„æŸ¥è¯¢æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œç‰¹åˆ«åœ¨å¤„ç†å¤§é‡çš„æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢å¯ä»¥è¦èŠ±è´¹å‡ åç§’ç”šè‡³å‡ åˆ†é’Ÿï¼Œè¿™å¯¹ç½‘ç«™çš„æ€§èƒ½æ˜¯éå¸¸è‡´å‘½çš„ã€‚

ç´¢å¼•æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œç´¢å¼•å­˜å‚¨åœ¨ä¸€ä¸ªæ˜“äºéå†è¯»å–çš„æ•°æ®é›†åˆä¸­ï¼Œç´¢å¼•æ˜¯å¯¹æ•°æ®åº“è¡¨ä¸­ä¸€åˆ—æˆ–å¤šåˆ—çš„å€¼è¿›è¡Œæ’åºçš„ä¸€ç§ç»“æ„

### 6.2. API

```markdown
# 1. åˆ›å»ºç´¢å¼•/v3.0ä¹‹å‰
db.collection_name.ensureIndex(keys, options)
# 2. åˆ›å»ºç´¢å¼•/v3.0ä¹‹å
db.collection_name.createIndex(keys, options)
# 3. æŸ¥çœ‹é›†åˆç´¢å¼•
db.collection_name.getIndexes()
# 4. æŸ¥çœ‹é›†åˆç´¢å¼•å¤§å°
db.collection_name.totalIndexSize()
# 5. åˆ é™¤é›†åˆæ‰€æœ‰ç´¢å¼•
db.collection_name.dropIndexes()
# 6. åˆ é™¤é›†åˆæŒ‡å®šç´¢å¼•
db.collection_name.dropIndex("ç´¢å¼•åç§°")
```

> è¯­æ³•æç¤ºï¼šè¯­æ³•ä¸­ Key å€¼ä¸ºä½ è¦åˆ›å»ºçš„ç´¢å¼•å­—æ®µï¼Œ1 ä¸ºæŒ‡å®šæŒ‰å‡åºåˆ›å»ºç´¢å¼•ï¼Œå¦‚æœä½ æƒ³æŒ‰é™åºæ¥åˆ›å»ºç´¢å¼•æŒ‡å®šä¸º -1 å³å¯ã€‚

options å‚æ•°ç±»å‹ï¼š

| Parameter          | Type          | Description                                                  |
| :----------------- | :------------ | :----------------------------------------------------------- |
| background         | Boolean       | å»ºç´¢å¼•è¿‡ç¨‹ä¼šé˜»å¡å…¶å®ƒæ•°æ®åº“æ“ä½œï¼Œbackgroundå¯æŒ‡å®šä»¥åå°æ–¹å¼åˆ›å»ºç´¢å¼•ï¼Œå³å¢åŠ  "background" å¯é€‰å‚æ•°ã€‚ "background" é»˜è®¤å€¼ä¸º**false**ã€‚ |
| unique             | Boolean       | å»ºç«‹çš„ç´¢å¼•æ˜¯å¦å”¯ä¸€ã€‚æŒ‡å®šä¸ºtrueåˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚é»˜è®¤å€¼ä¸º**false**. |
| name               | string        | ç´¢å¼•çš„åç§°ã€‚å¦‚æœæœªæŒ‡å®šï¼ŒMongoDBçš„é€šè¿‡è¿æ¥ç´¢å¼•çš„å­—æ®µåå’Œæ’åºé¡ºåºç”Ÿæˆä¸€ä¸ªç´¢å¼•åç§°ã€‚ |
| dropDups           | Boolean       | **3.0+ç‰ˆæœ¬å·²åºŸå¼ƒã€‚**åœ¨å»ºç«‹å”¯ä¸€ç´¢å¼•æ—¶æ˜¯å¦åˆ é™¤é‡å¤è®°å½•,æŒ‡å®š true åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚é»˜è®¤å€¼ä¸º **false**. |
| sparse             | Boolean       | å¯¹æ–‡æ¡£ä¸­ä¸å­˜åœ¨çš„å­—æ®µæ•°æ®ä¸å¯ç”¨ç´¢å¼•ï¼›è¿™ä¸ªå‚æ•°éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå¦‚æœè®¾ç½®ä¸ºtrueçš„è¯ï¼Œåœ¨ç´¢å¼•å­—æ®µä¸­ä¸ä¼šæŸ¥è¯¢å‡ºä¸åŒ…å«å¯¹åº”å­—æ®µçš„æ–‡æ¡£.ã€‚é»˜è®¤å€¼ä¸º **false**. |
| expireAfterSeconds | integer       | æŒ‡å®šä¸€ä¸ªä»¥ç§’ä¸ºå•ä½çš„æ•°å€¼ï¼Œå®Œæˆ TTLè®¾å®šï¼Œè®¾å®šé›†åˆçš„ç”Ÿå­˜æ—¶é—´ã€‚ |
| v                  | index version | ç´¢å¼•çš„ç‰ˆæœ¬å·ã€‚é»˜è®¤çš„ç´¢å¼•ç‰ˆæœ¬å–å†³äºmongodåˆ›å»ºç´¢å¼•æ—¶è¿è¡Œçš„ç‰ˆæœ¬ã€‚ |
| weights            | document      | ç´¢å¼•æƒé‡å€¼ï¼Œæ•°å€¼åœ¨ 1 åˆ° 99,999 ä¹‹é—´ï¼Œè¡¨ç¤ºè¯¥ç´¢å¼•ç›¸å¯¹äºå…¶ä»–ç´¢å¼•å­—æ®µçš„å¾—åˆ†æƒé‡ã€‚ |
| default_language   | string        | å¯¹äºæ–‡æœ¬ç´¢å¼•ï¼Œè¯¥å‚æ•°å†³å®šäº†åœç”¨è¯åŠè¯å¹²å’Œè¯å™¨çš„è§„åˆ™çš„åˆ—è¡¨ã€‚ é»˜è®¤ä¸ºè‹±è¯­ |
| language_override  | string        | å¯¹äºæ–‡æœ¬ç´¢å¼•ï¼Œè¯¥å‚æ•°æŒ‡å®šäº†åŒ…å«åœ¨æ–‡æ¡£ä¸­çš„å­—æ®µåï¼Œè¯­è¨€è¦†ç›–é»˜è®¤çš„languageï¼Œé»˜è®¤å€¼ä¸º language |

**# æ³¨æ„ï¼š**

åˆ©ç”¨ TTL é›†åˆå¯¹å­˜å‚¨çš„æ•°æ®è¿›è¡Œå¤±æ•ˆæ—¶é—´è®¾ç½®ï¼šç»è¿‡æŒ‡å®šçš„æ—¶é—´æ®µåæˆ–åœ¨æŒ‡å®šçš„æ—¶é—´ç‚¹è¿‡æœŸï¼ŒMongoDB ç‹¬ç«‹çº¿ç¨‹å»æ¸…é™¤æ•°æ®ã€‚ç±»ä¼¼äºè®¾ç½®å®šæ—¶è‡ªåŠ¨åˆ é™¤ä»»åŠ¡ï¼Œå¯ä»¥æ¸…é™¤å†å²è®°å½•æˆ–æ—¥å¿—ç­‰å‰ææ¡ä»¶ï¼Œè®¾ç½® Index çš„å…³é”®å­—æ®µä¸ºæ—¥æœŸç±»å‹ new Date()ã€‚

### 6.3. ç´¢å¼•ç±»å‹

**1ï¼‰_id ç´¢å¼•**

åˆ›å»ºé›†åˆæ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹MongoDBéƒ½ä¼šå¸®åŠ©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`_id`çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå›ºå®šé›†åˆä¸ä¼šå°† _id é»˜è®¤ä½œä¸ºç´¢å¼•ã€‚

**2ï¼‰å¤åˆç´¢å¼•**

å¦‚æœæˆ‘ä»¬çš„æŸ¥è¯¢æ¡ä»¶æœ‰å¤šä¸ªçš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹è¿™å¤šä¸ªæŸ¥è¯¢æ¡ä»¶éƒ½å»ºç«‹ç´¢å¼•ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å¯¹herosæ–‡æ¡£ä¸­çš„positionå’Œproficientå­—æ®µéƒ½å»ºç«‹ç´¢å¼•ï¼Œå¦‚ä¸‹ï¼š

```mysql
> db.heros.createIndex({position:1, proficient:1})
```

æ­¤æ—¶æ‰§è¡Œå¦‚ä¸‹æŸ¥è¯¢è¯­å¥æ—¶å°±ä¼šç”¨åˆ°è¿™ä¸ªå¤åˆç´¢å¼•ï¼š

```mysql
> db.heros.find({position:"æ³•å¸ˆ", proficient:{$gt:1000}})
```

ä¸Šè¿°ç¤ºä¾‹æŸ¥è¯¢è‹±é›„å®šä½ä¸ºæ³•å¸ˆå¹¶ä¸”ç†Ÿç»ƒåº¦åœ¨1000ä»¥ä¸Šçš„æ•°æ®ã€‚

**3ï¼‰è¿‡æœŸç´¢å¼•**

è¿‡æœŸç´¢å¼•å°±æ˜¯ä¸€ç§ä¼šè¿‡æœŸçš„ç´¢å¼•ï¼Œåœ¨ç´¢å¼•è¿‡æœŸä¹‹åï¼Œç´¢å¼•å¯¹åº”çš„æ•°æ®ä¼šè¢«åˆ é™¤ï¼Œåˆ›å»ºæ–¹å¼å¦‚ä¸‹ï¼š

```mysql
> db.collection_name.createIndex({time:1},{expireAfterSeconds:30})
```

expireAfterSecondsè¡¨ç¤ºç´¢å¼•çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚timeè¡¨ç¤ºç´¢å¼•çš„å­—æ®µï¼Œtimeçš„æ•°æ®ç±»å‹å¿…é¡»æ˜¯ISODateæˆ–è€…ISODateæ•°ç»„ï¼Œå¦åˆ™çš„è¯ï¼Œå½“ç´¢å¼•è¿‡æœŸä¹‹åï¼Œtimeçš„æ•°æ®å°±ä¸ä¼šè¢«åˆ é™¤ã€‚

**4ï¼‰å…¨æ–‡ç´¢å¼•**

[å‚è€ƒåœ°å€ >>](https://docs.mongodb.com/manual/reference/text-search-languages/)

MongoDB ä»3.2 ç‰ˆæœ¬ä»¥åæ·»åŠ äº†å¯¹ä¸­æ–‡ç´¢å¼•çš„æ”¯æŒã€‚ä¸‹é¢ç»™å¤§å®¶ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘çš„æ•°æ®æ˜¯è¿™æ ·çš„ï¼š

```
{"name":"é˜¿ç‚", "position": "åˆºå®¢", "location": "é‡åŒº", "speciality":"çªè¿›/æ”¶å‰²"}
{"name":"å…³ç¾½", "position": "æˆ˜å£«", "location": "ä¸Šè·¯", "speciality":"çªè¿›/å…ˆæ‰‹"}
{"name":"å©‰å„¿", "position": "æ³•åˆº", "location": "ä¸­è·¯", "speciality":"çªè¿›/æ”¶å‰²"}
{"name":"è’™çŠ½", "position": "å°„æ‰‹", "location": "ä¸‹è·¯", "speciality":"è¿œç¨‹/æ¶ˆè€—"}
{"name":"æç™½", "position": "åˆºå®¢", "location": "é‡åŒº", "speciality":"çªè¿›/æ”¶å‰²"}
```

æˆ‘ä»¬å¯ä»¥ç»™ speciality å­—æ®µæ·»åŠ ä¸€ä¸ªå…¨æ–‡ç´¢å¼•ï¼Œå€¼ä¸º `text`

```mysql
> db.heros.createIndex({speciality: "text"});
```

MongoDBä¼šè‡ªåŠ¨å¯¹specialityå­—æ®µçš„æ•°æ®è¿›è¡Œåˆ†è¯ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¦‚ä¸‹è¯­å¥è¿›è¡ŒæŸ¥è¯¢ï¼š

```mysql
> db.heros.find({$text:{$search:"çªè¿›"}})
```

# ä¸ƒã€ç”¨æˆ·ç®¡ç†

1ï¼‰åŸºç¡€å‘½ä»¤

```markdown
# 1. åˆ›å»ºç”¨æˆ·
db.createUser({user:'è´¦å·', pwd:'å¯†ç ', roles:[{role:'è§’è‰²å', db: 'æ•°æ®åº“å'}]})
# 2. æŸ¥çœ‹ç”¨æˆ·
db.getUsers()
# 3. ç§»é™¤ç”¨æˆ·
db.dropUser("ç”¨æˆ·å")
# 4. ç”¨æˆ·ç™»é™†
db.auth(user, pwd) 
# 5. ä¿®æ”¹ç”¨æˆ·å¯†ç 
db.changeUserPassword('ç”¨æˆ·å', 'æ–°å¯†ç ')
```

ä»£ç ç¤ºä¾‹ï¼š

```mysql
# åˆ›å»ºè¶…çº§ç”¨æˆ·
> use admin
> db.createUser({user:'root', pwd:'123', roles:[{role:'root', db: 'admin'}]})
# åˆ›å»ºæ™®é€šç”¨æˆ·
> db.createUser({user:'lee', pwd:'123', roles:[{role:'readWrite', db: 'DB-TEST'}]})
```

> æç¤ºï¼šåˆ›å»ºæ™®é€šç”¨æˆ·æ—¶éœ€å…ˆç™»é™†è¶…çº§ç”¨æˆ·å†åˆ›å»ºã€‚

2ï¼‰è§’è‰²åˆ†ç±»

- æ•°æ®åº“ç”¨æˆ·è§’è‰²ï¼š`read`ã€`readWrite`
- æ•°æ®åº“ç®¡ç†å‘˜è§’è‰²ï¼š`dbAdmin`ã€`dbOwner`ã€`userAdmin`
- é›†ç¾¤ç®¡ç†å‘˜è§’è‰²ï¼š`clusterAdmin`ã€`clusterManager`ã€`clusterMonitor`ã€`hostManager`
- å¤‡ä»½å’Œæ¢å¤è§’è‰²ï¼š`backup`ã€`restore`
- æ‰€æœ‰æ•°æ®åº“è§’è‰²ï¼š`readAnyDatabase`ã€`readWriteAnyDatabase`ã€`userAdminAnyDatabase`ã€`dbAdminAnyDatabase`
- è¶…çº§ç”¨æˆ·è§’è‰²ï¼š`root`

3ï¼‰è§’è‰²åŠŸèƒ½

- `read`ï¼šå…è®¸ç”¨æˆ·è¯»å–æŒ‡å®šæ•°æ®åº“
- `readWrite`ï¼šå…è®¸ç”¨æˆ·è¯»å†™æŒ‡å®šæ•°æ®åº“
- `readAnyDatabase`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰æ•°æ®åº“çš„è¯»æƒé™
- `readWriteAnyDatabase`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰æ•°æ®åº“çš„è¯»å†™æƒé™
- `dbAdmin`ï¼šå…è®¸ç”¨æˆ·åœ¨æŒ‡å®šæ•°æ®åº“ä¸­æ‰§è¡Œç®¡ç†å‡½æ•°ï¼Œå¦‚ç´¢å¼•åˆ›å»ºã€åˆ é™¤ï¼ŒæŸ¥çœ‹ç»Ÿè®¡æˆ–è®¿é—®`system.profile`
- `dbAdminAnyDatabase`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰æ•°æ®åº“çš„`dbAdmin`æƒé™ã€‚
- `userAdmin`ï¼šå…è®¸ç”¨æˆ·å‘`system.users`é›†åˆå†™å…¥ï¼Œå¯ä»¥æ‰¾æŒ‡å®šæ•°æ®åº“é‡Œåˆ›å»ºã€åˆ é™¤å’Œç®¡ç†ç”¨æˆ·
- `userAdminAnyDatabase`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰æ•°æ®åº“çš„`userAdmin`æƒé™
- `clusterAdmin`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ï¼Œèµ‹äºˆç”¨æˆ·æ‰€æœ‰åˆ†ç‰‡å’Œå¤åˆ¶é›†ç›¸å…³å‡½æ•°çš„ç®¡ç†æƒé™ã€‚
- `root`ï¼šåªåœ¨`admin`æ•°æ®åº“ä¸­å¯ç”¨ã€‚è¶…çº§è´¦å·ï¼Œè¶…çº§æƒé™

# å…«ã€å†…ç½®è¿ç®—ç¬¦

[å‚è€ƒæŒ‡å— >>](https://docs.mongoing.com/can-kao/yun-suan-fu)

## é™„å½•1ï¼šæŸ¥è¯¢æ“ä½œç¬¦

- `$in`ï¼šæŸ¥è¯¢å€¼ä¸ºæŒ‡å®šé›†åˆä¸­æŸä¸ªå…ƒç´ æ—¶
- `$nin`ï¼šæŸ¥è¯¢å€¼ä¸ä¸ºæŒ‡å®šé›†åˆä¸­æŸä¸ªå…ƒç´ æ—¶
- `$gt[e]`ï¼šå¤§äº[ç­‰äº]æŸä¸ªå€¼
- `$lt[e]`ï¼šå°äº[ç­‰äº]æŸä¸ªå€¼
- `$ne`ï¼šä¸ç­‰äºæŸä¸ªå€¼
- `$or`ï¼šæˆ–æŸ¥è¯¢
- `$all`ï¼šåŒ¹é…æ‰€æœ‰

## é™„å½•2ï¼š[æ›´æ–°æ“ä½œç¬¦ >>](https://www.mongodb.com/docs/manual/reference/operator/update/)

### Fields

- `$currentDate`ï¼šå°†å­—æ®µçš„å€¼è®¾ç½®ä¸ºå½“å‰æ—¥æœŸï¼Œå¯ä»¥æ˜¯æ—¥æœŸæˆ–æ—¶é—´æˆ³ã€‚*
- `$inc`ï¼šå°†å­—æ®µçš„å€¼å¢åŠ /ç´¯åŠ æŒ‡å®šæ•°é‡ã€‚*
- `$min`ï¼šä»…å½“æŒ‡å®šå€¼å°äºç°æœ‰å­—æ®µå€¼æ—¶æ‰æ›´æ–°å­—æ®µã€‚
- `$max`ï¼šä»…å½“æŒ‡å®šå€¼å¤§äºç°æœ‰å­—æ®µå€¼æ—¶æ‰æ›´æ–°å­—æ®µã€‚
- `$mul`ï¼šå°†å­—æ®µçš„å€¼ä¹˜ä»¥æŒ‡å®šçš„é‡ã€‚
- `$rename`ï¼šé‡å‘½åä¸€ä¸ªå­—æ®µã€‚
- `$set`ï¼šè®¾ç½®æ–‡æ¡£ä¸­æŸä¸ªå­—æ®µçš„å€¼ã€‚*
- `$setOnInsert`ï¼šä»æ–‡æ¡£ä¸­æ’å…¥æŒ‡å®šçš„å­—æ®µã€‚
- `$unset`ï¼šä»æ–‡æ¡£ä¸­ç§»é™¤æŒ‡å®šçš„å­—æ®µã€‚

### Array

- `$push`ï¼šå‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªé¡¹ã€‚
- `$pop`ï¼šç§»é™¤æ•°ç»„çš„ç¬¬ä¸€é¡¹æˆ–æœ€åä¸€é¡¹ã€‚
- `$pull`ï¼šåˆ é™¤ä¸æŒ‡å®šæŸ¥è¯¢åŒ¹é…çš„æ‰€æœ‰æ•°ç»„å…ƒç´ ã€‚
- `$pull`ï¼šä»æ•°ç»„ä¸­ç§»é™¤æ‰€æœ‰åŒ¹é…çš„å€¼ã€‚
- `$addToSet`ï¼šä»…å½“æ•°ç»„ä¸­ä¸å­˜åœ¨å…ƒç´ æ—¶ï¼Œæ‰å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ ã€‚

# ä¹ã€å¯è§†åŒ–å·¥å…·

1. [å‰å¾€ä¸‹è½½ Nacicat Premium >>](https://www.navicat.com.cn/products/navicat-premium)
2. [å‰å¾€ä¸‹è½½ MongoDB Compass >>](https://www.mongodb.com/try/download/compass)
3. [å‰å¾€ä¸‹è½½ Robo 3T >>](https://studio3t.com/download/)

å‚è€ƒæŒ‡å—ï¼š

- [Navicat Premium 16.0.10 ç ´è§£å®‰è£…æŒ‡å— >>](https://cloud.tencent.com/developer/article/1953103)

# åã€æ‰©å±•

## 1. å¿˜è®°å¯†ç 

### macOS

```shell
sudo vim /etc/mongodb.conf     # ä¿®æ”¹ mongodb é…ç½®ï¼Œå°† auth = true æ³¨é‡Šæ‰ï¼Œæˆ–è€…æ”¹æˆ false
...							               # å‚ç…§ä¸Šè¿°ç¤ºä¾‹ï¼Œé‡å¯mongoæœåŠ¡
mongo                          # è¿è¡Œå®¢æˆ·ç«¯ï¼ˆä¹Ÿå¯ä»¥å»mongodbå®‰è£…ç›®å½•ä¸‹è¿è¡Œè¿™ä¸ªï¼‰
use admin                      # åˆ‡æ¢åˆ°ç³»ç»Ÿå¸æˆ·è¡¨
db.getUsers()                  # æŸ¥çœ‹å½“å‰å¸æˆ·ï¼ˆå¯†ç æœ‰åŠ å¯†è¿‡ï¼‰
db.system.users.remove({})     # åˆ é™¤æ‰€æœ‰å¸æˆ·
db.addUser('admin','password') # æ·»åŠ æ–°å¸æˆ·

sudo vim /etc/mongodb.conf     # æ¢å¤ auth = true
service mongodb restart        # é‡å¯ mongodb æœåŠ¡
...							               # å‚ç…§ä¸Šè¿°ç¤ºä¾‹ï¼Œé‡å¯mongoæœåŠ¡
```







